# ============================================================================
# GitHub Actions Workflow - Mise √† Jour Automatique des Stats
# ============================================================================
#
# Ce workflow met √† jour automatiquement votre profil GitHub avec vos
# statistiques les plus r√©centes, incluant les d√©p√¥ts priv√©s.
#
# D√©clencheurs:
# - Tous les jours √† 00:00 UTC (schedule)
# - Manuel via l'interface GitHub (workflow_dispatch)
# - Push sur la branche main (optionnel)
#
# ============================================================================

name: üìä Update GitHub Stats

on:
  # Ex√©cution automatique tous les jours √† minuit UTC
  schedule:
    - cron: '0 0 * * *'  # Tous les jours √† 00:00 UTC
  
  # Permettre le d√©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      clear_cache:
        description: 'Nettoyer le cache avant ex√©cution'
        required: false
        type: boolean
        default: false
      
      dry_run:
        description: 'Mode dry-run (ne pas publier sur GitHub)'
        required: false
        type: boolean
        default: false
  
  # Optionnel: Ex√©cuter sur push (d√©commentez si d√©sir√©)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'scripts/**'
  #     - 'src/**'
  #     - 'configs/**'

# Permissions n√©cessaires pour le workflow
permissions:
  contents: write  # Pour commit et push le README

jobs:
  update-stats:
    name: üîÑ Mettre √† jour les statistiques
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout du repository
      # -----------------------------------------------------------------------
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # R√©cup√©rer tout l'historique
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # -----------------------------------------------------------------------
      # 2. Configuration de Python
      # -----------------------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache des d√©pendances pip
      
      # -----------------------------------------------------------------------
      # 3. Installation des d√©pendances
      # -----------------------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml
          
          # V√©rifier l'installation
          python --version
          pip list
      
      # -----------------------------------------------------------------------
      # 4. Afficher les informations de l'environnement
      # -----------------------------------------------------------------------
      - name: ‚ÑπÔ∏è Display environment info
        run: |
          echo "üîç Informations de l'environnement:"
          echo "   Python: $(python --version)"
          echo "   Utilisateur: ${{ github.repository_owner }}"
          echo "   Repository: ${{ github.repository }}"
          echo "   Workflow: ${{ github.workflow }}"
          echo "   Run ID: ${{ github.run_id }}"
          echo ""
          echo "üïê Temps d'ex√©cution: $(date)"
      
      # -----------------------------------------------------------------------
      # 5. Nettoyer le cache (si demand√©)
      # -----------------------------------------------------------------------
      - name: üßπ Clear cache
        if: github.event.inputs.clear_cache == 'true'
        run: |
          echo "üßπ Nettoyage du cache..."
          rm -rf .cache/
          echo "‚úÖ Cache nettoy√©"
      
      # -----------------------------------------------------------------------
      # 6. Ex√©cuter le script de mise √† jour
      # -----------------------------------------------------------------------
      - name: üöÄ Run update script
        env:
          # IMPORTANT: Utilisez un Personal Access Token avec les permissions appropri√©es
          # Cr√©ez un secret nomm√© STATS_TOKEN dans les settings de votre repo
          # Si vous n'avez pas de STATS_TOKEN, le workflow utilisera GITHUB_TOKEN par d√©faut
          GITHUB_TOKEN: ${{ secrets.STATS_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          CACHE_ENABLED: 'true'
          LOG_LEVEL: 'INFO'
        run: |
          echo "üöÄ D√©marrage de la mise √† jour des statistiques..."
          
          # Construire les options
          OPTIONS=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            OPTIONS="$OPTIONS --dry-run"
            echo "‚ÑπÔ∏è Mode dry-run activ√©"
          fi
          
          # Ex√©cuter le script
          python scripts/update_stats.py $OPTIONS
          
          echo "‚úÖ Script termin√© avec succ√®s"
      
      # -----------------------------------------------------------------------
      # 7. V√©rifier les changements
      # -----------------------------------------------------------------------
      - name: üîç Check for changes
        id: check_changes
        run: |
          # V√©rifier si le README a √©t√© modifi√©
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Aucun changement d√©tect√© dans le README"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changements d√©tect√©s dans le README"
            
            # Afficher les statistiques des changements
            echo ""
            echo "üìä Statistiques des changements:"
            git diff --stat README.md
          fi
      
      # -----------------------------------------------------------------------
      # 8. Commit et push (si changements et pas en dry-run)
      # -----------------------------------------------------------------------
      - name: üíæ Commit and push changes
        if: |
          steps.check_changes.outputs.changed == 'true' && 
          github.event.inputs.dry_run != 'true'
        run: |
          # Configuration Git
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit
          git add README.md stats/ || true
          git commit -m "ü§ñ Auto-update GitHub stats - $(date +'%Y-%m-%d %H:%M')" \
                     -m "Updated by GitHub Actions workflow" \
                     -m "Run ID: ${{ github.run_id }}" \
                     -m "Triggered by: ${{ github.event_name }}"
          
          # Push
          git push origin main || git push origin master || {
            echo "‚ùå Erreur lors du push"
            echo "V√©rifiez que le workflow a les permissions d'√©criture"
            exit 1
          }
          
          echo "‚úÖ Changements commit√©es et pouss√©s avec succ√®s"
      
      # -----------------------------------------------------------------------
      # 9. R√©sum√© de l'ex√©cution
      # -----------------------------------------------------------------------
      - name: üìã Execution summary
        if: always()
        run: |
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "           üìä R√âSUM√â DE L'EX√âCUTION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "‚úÖ Statut: ${{ job.status }}"
          echo "üïê Termin√© √†: $(date)"
          echo "üîó Profil: https://github.com/${{ github.repository_owner }}"
          echo ""
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "üìù README mis √† jour avec succ√®s!"
          else
            echo "‚ÑπÔ∏è Aucune mise √† jour n√©cessaire"
          fi
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
      
      # -----------------------------------------------------------------------
      # 10. Gestion des erreurs
      # -----------------------------------------------------------------------
      - name: ‚ùå Handle errors
        if: failure()
        run: |
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "           ‚ùå ERREUR LORS DE L'EX√âCUTION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "Une erreur s'est produite lors de l'ex√©cution du workflow."
          echo ""
          echo "üîç Actions de d√©pannage:"
          echo "   1. V√©rifiez que GITHUB_TOKEN ou STATS_TOKEN est configur√©"
          echo "   2. V√©rifiez les permissions du token (repo, user)"
          echo "   3. Consultez les logs ci-dessus pour plus de d√©tails"
          echo ""
          echo "üìö Documentation: https://docs.github.com/actions"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          exit 1

# ============================================================================
# Configuration du Token
# ============================================================================
#
# Pour que ce workflow fonctionne correctement, vous devez cr√©er un
# Personal Access Token (PAT) avec les permissions appropri√©es:
#
# 1. Allez sur https://github.com/settings/tokens
# 2. Cliquez sur "Generate new token (classic)"
# 3. Donnez un nom: "GitHub Stats Automation"
# 4. S√©lectionnez les scopes:
#    ‚úì repo (Full control of private repositories)
#    ‚úì user (Read user profile data)
# 5. G√©n√©rez le token
# 6. Copiez le token
# 7. Allez dans Settings > Secrets and variables > Actions de votre repo
# 8. Cr√©ez un nouveau secret nomm√© "STATS_TOKEN"
# 9. Collez le token
#
# Note: Le GITHUB_TOKEN par d√©faut ne peut pas acc√©der aux repos priv√©s,
#       c'est pourquoi un PAT est n√©cessaire.
#
# ============================================================================

